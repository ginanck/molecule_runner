FROM python:3.8-alpine3.18

LABEL maintainer="ginanck"
LABEL description="Molecule testing environment with Alpine Linux and Python 3.8"
LABEL python.version="3.8"

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Install system dependencies
RUN apk add --no-cache \
    bash \
    curl \
    git \
    openssh-client \
    docker-cli \
    gcc \
    musl-dev \
    libffi-dev \
    openssl-dev \
    cargo \
    rust \
    && rm -rf /var/cache/apk/*

# Upgrade pip and install Python packages
RUN pip install --upgrade pip setuptools wheel

# Copy requirements files
COPY requirements.txt /tmp/

# Install Python packages from requirements files
RUN pip install --no-cache-dir -r /tmp/requirements.txt && \
    rm -f /tmp/requirements.txt

# Create ansible user and directories
RUN addgroup -g 1000 ansible && \
    adduser -D -u 1000 -G ansible ansible && \
    mkdir -p /home/ansible/.ansible/collections && \
    chown -R ansible:ansible /home/ansible

# Switch to ansible user
USER ansible

# Install Ansible collections as the ansible user
RUN ansible-galaxy collection install community.docker:4.8.1

# Set working directory
WORKDIR /workspace

# Switch back to root for GitHub Actions compatibility
USER root

# Set default command
CMD ["/bin/bash"]
