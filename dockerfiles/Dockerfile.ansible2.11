FROM python:3.9-alpine3.18

LABEL org.opencontainers.image.source=https://github.com/ginanck/molecule_runner
LABEL org.opencontainers.image.description="Ultra-lightweight Molecule testing environment with Python 3.9 and Ansible 2.11.12"

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Install minimal system dependencies and build tools temporarily
RUN apk add --no-cache \
        bash \
        git \
        curl \
        openssh-client \
        docker-cli \
        ca-certificates \
        py3-cryptography \
        py3-yaml \
        py3-jinja2 \
        py3-packaging \
        py3-pip \
        py3-setuptools \
        py3-wheel \
        py3-cryptography \
    && rm -rf /var/cache/apk/*

# Install Docker CLI
RUN apk add --no-cache docker-cli

# Copy requirements files
COPY requirements.txt /tmp/

# Install Python packages
RUN pip install --no-cache-dir -r /tmp/requirements.txt \
    && rm -f /tmp/requirements.txt \
    && rm -rf /root/.cache

# Set working directory and switch back to root for GitHub Actions compatibility
WORKDIR /workspace
USER root

# Set default command
CMD ["/bin/bash"]
